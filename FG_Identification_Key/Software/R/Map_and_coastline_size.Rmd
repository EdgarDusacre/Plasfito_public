---
title: "maps_FE"
author: "Edgar"
date: "2024-06-22"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r package upload}
library(ggplot2)
library(tidyr)
library(forcats)
library(dplyr)
library(readxl) 
library(readr)
library(RColorBrewer)
library(tidyverse)
library(binom)
library(lubridate)
library(ade4)
library(ggrepel)
library(broom)
library(ggpubr)
library(rstatix)
library(wesanderson)
library(car)
library(multcompView)
library(rcompanion)
library(writexl)
library(gmodels)
library(openxlsx)
library(fmsb)


#OFW
library(maps)
library(sf)
library(furrr)
library(raster)
library(ggthemes)
library(terra)
library(marmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
library(ggspatial)
library(osmdata)
library(grid)
library(geosphere)

```


```{r data import}

ports <- tibble::tribble(
  ~Port,            ~latitude,  ~longitude, ~label_position, ~legend_pt,        ~label_port,              ~country,
  "La Cotinière",    45.91306,   -1.32778,  "left",         "French ports",    "La Cotinière",           "France",
  "Arcachon",        44.65230,   -1.17850,  "left",         "French ports",    "Arcachon",               "France",
  "Bayonne",         43.49000,   -1.48000,  "left",         "French ports",    "Bayonne",                "France",
  "Saint-Jean-de-Luz",43.39000,  -1.66000,  "right",         "French ports",    "Saint-Jean-de-Luz",      "France",
  "Pasaia",          43.32528,   -1.92111,  "below",         "Spanish ports",    "Pasaia",                 "Spain",
  "Ondarroa",        43.32194,   -2.41944,  "below",         "Spanish ports",    "Ondarroa",               "Spain",
  "Bermeo",          43.42083,   -2.72139,  "top",         "Spanish ports",    "Bermeo",                 "Spain",
  "Bilbao",          43.35000,   -3.03333,  "below",         "Spanish ports",    "Bilbao",                 "Spain",
  "Santander",       43.46306,   -3.80444,  "top",         "Spanish ports","Santander",              "Spain"
)
ports

Sampled_beaches <- read_excel("Datasheets/Sampled_beaches.xlsx", na = "NA") %>%
  mutate(latitude = as.numeric(latitude),
         longitude = as.numeric(longitude),
         label_position = ifelse(substr(code, 1, 2) == "FR", "right", "below"),
         legend_pt = ifelse(label_position == "right", "French beaches", "Basque Country beaches")) %>% 
  filter(!is.na(code)) %>% 
   mutate(label_beach = paste(code, Beaches, sep = " = "))
Sampled_beaches

# World polygons from the maps package
world_shp <- sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))

# # Load EEZ polygons
# eezs <- read_sf("Geodata/World_EEZ_v12_20231025", layer = 'eez_v12') %>% 
#   filter(POL_TYPE == '200NM') # select the 200 nautical mile polygon layer
# eezs

# Get high-resolution data for Europe
europe_high_res <- ne_countries(scale = "large", returnclass = "sf", continent = "Europe")
# Get high-resolution coastline data
coastline_high_res <- ne_coastline(scale = "large", returnclass = "sf")
```

```{r}

# Obtenir les données administratives de la France (résolution moyenne)
france_adm1 <- ne_states(country = "france", returnclass = "sf")
france_adm1
# Filtrer pour obtenir la Nouvelle-Aquitaine
nouvelle_aquitaine <- france_adm1 %>% 
  filter(region == "Nouvelle-Aquitaine") %>%
  summarise(geometry = st_union(geometry))

# Obtenir les données administratives de la France (résolution moyenne)
spain_adm1 <- ne_states(country = "spain", returnclass = "sf")
spain_adm1
# Filtrer pour obtenir la Nouvelle-Aquitaine
BC <- spain_adm1 %>% 
  filter(region == "País Vasco") %>%
  summarise(geometry = st_union(geometry))



pt_color <- c("French beaches" = "#0039D8", "Basque Country beaches" = "#009B48")
hb_color <- c("French ports" = "#0039D8", "Spanish ports" = "#009B48")

# Create a data frame for the studied area
studied_area_df <- data.frame(
  xmin = -4.0,
  xmax = -1.0,
  ymin = 43.2,
  ymax = 46.3,
  area = "Studied area"
)

Sampled_beaches$legend_pt <- factor(Sampled_beaches$legend_pt, 
                                    levels = c("French beaches", "Basque Country beaches"))


```


```{r General with harbor}


Plasfito_ports <- ggplot() +
  # Add white background
  geom_rect(aes(xmin = -5.2, xmax = -0.0, ymin = 42.8, ymax = 48.25), 
            fill = "white", color = NA) +
  
  # Add Plasfito area with legend
  geom_rect(data = studied_area_df, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = area), 
            color = NA, alpha = 1) +
  scale_fill_manual(values = c("Studied area" = "#80CAD0"), name = "") +
  # Add background continent
  geom_sf(data = europe_high_res, fill = "lightgrey", color = "black", size = 0.2) +
  # Add background coastline
  #geom_sf(data = coastline_high_res, color = "blue", size = 0.3) +
  # Add frontier regions
  geom_sf(data = nouvelle_aquitaine, fill = NA, color = "black", size = 3) +
  geom_sf(data = BC, fill = NA, color = "black", size = 3) +
  # Add north arrow
  annotation_north_arrow(location = "tr", 
                         which_north = "true",
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering,
                         height = unit(1, "cm"), width = unit(1, "cm")) +
  # Add scale bar
  annotation_scale(location = "br", width_hint = 0.3, text_cex = 0.7, 
                   pad_x = unit(0.2, "cm"), pad_y = unit(1.3, "cm"),
                   style = "bar", bar_cols = c("black", "white"),
                   line_width = 1, height = unit(0.2, "cm"),
                   text_family = "sans", text_face = "bold") +
  # Add sampling beaches
  geom_point(data = ports, aes(x = longitude, y = latitude, color = legend_pt), size = 3) +
  scale_color_manual(values = hb_color) +
  geom_text_repel(data = ports, 
                  aes(x = longitude, y = latitude, label = Port, 
                      hjust = ifelse(label_position == "left", 1.1, 
                                     ifelse(label_position == "right", -0.05, 
                                            ifelse(label_position == "top", 0.5, 
                                                   ifelse(label_position == "below", 0.5, NA)))), 
                      vjust = ifelse(label_position == "left", 0.5, 
                                     ifelse(label_position == "right", 0, 
                                            ifelse(label_position == "top", -1, 
                                                   ifelse(label_position == "below", 1.5, NA))))),
                  size = 3.5, 
                  color = "black",
                  fontface = "bold",
                  box.padding = 0.1,
                  point.padding = 0.1,
                  segment.color = "transparent") +
  coord_sf(xlim = c(-5.0, -0.2), ylim = c(42.8, 48.0)) +
  theme_minimal() +
  labs(title = "Studied area of the Plasfito research project\n",
       color = "") +
  theme(
    # panel.background = element_blank(),
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 20, face = "bold", vjust = 0.5, margin = margin(t = 10, r = 20, b = 0, l = 0)),
    axis.title.y = element_text(size = 20, face = "bold", vjust = 3, margin = margin(t = 0, r = 5, b = 0, l = 0)),
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.text.y = element_text(size = 12, face = 'bold'),
    title = element_text(size = 22, face = "bold", margin = margin(t = 10, r = 0, b = 20, l = 0)),
    strip.text = element_text(face = "bold", size = rel(2)),
    strip.background = element_rect(fill = "grey", color = "grey", linewidth = 0.1),
    legend.position = "right",
    #legend.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.spacing.y = unit(-0.7, "cm"),
    legend.title = element_text(size = 18, face = 'bold'),
    legend.text = element_text(size = 14, face = 'bold')) +
  labs(caption = "Legend") +
  theme(plot.caption = element_text(family = "Arial",
               face = "bold",
               color = 1,
               size = 18,
               hjust = 1.23,
               vjust = 115,
               angle = 0,
               lineheight = 1))

Plasfito_ports

```


```{r Map paper}

pt_color <- c("FR1 = Le Truc Vert" = "#0039D8", 
              "FR2 = Banc d'Arguin" = "#0039D8", 
              "FR3 = Le Wharf" = "#0039D8", 
              "FR4 = Champ-de-tire" = "#0039D8", 
              "ES1 = Murgita" = "#009B48",
              "ES2 = Orrua" = "#009B48",
              "ES3 = Alkolea" = "#009B48",
              "ES4 = Gorrondatxe" = "#009B48")

Sampled_beaches$label_beach <- factor(Sampled_beaches$label_beach, 
                                      levels = c("FR1 = Le Truc Vert", 
                                                 "FR2 = Banc d'Arguin", 
                                                 "FR3 = Le Wharf", 
                                                 "FR4 = Champ-de-tire", 
                                                 "ES1 = Murgita",
                                                 "ES2 = Orrua",
                                                 "ES3 = Alkolea",
                                                 "ES4 = Gorrondatxe"))

Plasfito <- ggplot() +
  # Add white background
  geom_rect(aes(xmin = -5.2, xmax = -0.0, ymin = 42.8, ymax = 48.25), 
            fill = "white", color = NA) +
   # Add Plasfito area with legend
  geom_rect(data = studied_area_df, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = area), 
            color = NA, alpha = 1) +
  scale_fill_manual(values = c("Studied area" = "#80CAD0"), name = "") +
  # Add background continent
  geom_sf(data = europe_high_res, fill = "lightgrey", color = "black", size = 0.2) +
  # Add frontier regions
  geom_sf(data = nouvelle_aquitaine, fill = NA, color = "black", size = 3) +
  geom_sf(data = BC, fill = NA, color = "black", size = 3) +
  # Add north arrow
  annotation_north_arrow(location = "tr", 
                         which_north = "true",
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering,
                         height = unit(1, "cm"), width = unit(1, "cm")) +
  # Add scale bar
  annotation_scale(location = "br", width_hint = 0.3, text_cex = 0.7, 
                   pad_x = unit(0.2, "cm"), pad_y = unit(0.4, "cm"),
                   style = "bar", bar_cols = c("black", "white"),
                   line_width = 1, height = unit(0.2, "cm"),
                   text_family = "sans", text_face = "bold") +
  # Add sampling beaches
  geom_point(data = Sampled_beaches, aes(x = longitude, y = latitude, color = label_beach), size = 3) +
  scale_color_manual(values = pt_color) +
  geom_text_repel(data = Sampled_beaches, 
                  aes(x = longitude, y = latitude, label = code, 
                      hjust = ifelse(label_position == "right", 1.3, 0.5), 
                      vjust = ifelse(label_position == "below", 0.5, 0.5)),
                  size = 5, 
                  color = "black",
                  fontface = "bold",
                  box.padding = 0.2,
                  point.padding = 0.1,
                  segment.color = "transparent") +
  coord_sf(xlim = c(-5.0, -0.2), ylim = c(42.8, 48.0)) +
  theme_minimal() +
  labs(#title = "Studied area of the Plasfito research project",
       color = "Sampled beaches",
       fill = "") +
  theme(
    axis.title.x = element_text(size = 20, face = "bold", vjust = 0.5, margin = margin(t = 10, r = 20, b = 0, l = 0)),
    axis.title.y = element_text(size = 20, face = "bold", vjust = 3, margin = margin(t = 0, r = 5, b = 0, l = 0)),
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.text.y = element_text(size = 12, face = 'bold'),
    title = element_text(size = 22, face = "bold", margin = margin(t = 10, r = 0, b = 20, l = 0)),
    strip.text = element_text(face = "bold", size = rel(2)),
    strip.background = element_rect(fill = "grey", color = "grey", linewidth = 0.1),
    legend.position = "right",
    legend.spacing.y = unit(0.1, "cm"),
    legend.title = element_text(size = 18, face = 'bold'),
    legend.text = element_text(size = 14, face = 'bold')) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)) + # Add black contour
guides(fill = guide_legend(title = "", order = 1),
    color = guide_legend(order = 2))

Plasfito 



```

```{r length coastline}

# Obtenir les données du trait de côte à haute résolution
coastline <- ne_coastline(scale = 10, returnclass = "sf")

# Définir les points de début et de fin
start_point <- c(-1.260000, 46.320000)
end_point <- c(-4.03000, 43.44000)

# Créer une ligne entre les points de début et de fin
line <- st_sfc(st_linestring(rbind(start_point, end_point)), crs = st_crs(coastline))

# Créer un buffer autour de cette ligne pour capturer le trait de côte
buffer <- st_buffer(line, dist = 0.1)  # Réduire le buffer à 0.1 degré pour plus de précision

# Découper le trait de côte avec ce buffer
coastline_subset <- st_intersection(coastline, buffer)

# Convertir le trait de côte en points avec une résolution plus élevée
coastline_points <- st_cast(coastline_subset, "POINT")
coords <- st_coordinates(coastline_points)

# Calculer la distance le long du trait de côte
total_length <- 0
for (i in 1:(nrow(coords) - 1)) {
  total_length <- total_length + distGeo(coords[i, ], coords[i+1, ])
}

# Convertir en kilomètres et arrondir
length_km <- round(total_length / 1000, 2)

print(paste("Longueur estimée du trait de côte :", length_km, "km"))


```
